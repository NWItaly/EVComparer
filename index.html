<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VoltTool</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="shared.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>

<body>

  <!-- Nav iniettata da nav.js -->

  <!-- MODAL -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h3 id="modal-title"></h3>
      <p id="modal-desc"></p>
      <input type="number" id="modal-input" step="any" />
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btn-cancel"></button>
        <button class="btn btn-primary" id="btn-ok"></button>
      </div>
    </div>
  </div>

  <!-- PRESET POPUPS -->
  <div class="preset-popup" id="popup-kml">
    <div class="preset-card" id="pc-kml-city"> <span class="pc-icon">ğŸ™ï¸</span><span class="pc-label"></span><span
        class="pc-value fuel-color">21 km/L</span></div>
    <div class="preset-card" id="pc-kml-mid"> <span class="pc-icon">ğŸš—</span><span class="pc-label"></span><span
        class="pc-value fuel-color">17 km/L</span></div>
    <div class="preset-card" id="pc-kml-sport"> <span class="pc-icon">ğŸï¸</span><span class="pc-label"></span><span
        class="pc-value fuel-color">12 km/L</span></div>
  </div>
  <div class="preset-popup" id="popup-kwh">
    <div class="preset-card" id="pc-kwh-city"> <span class="pc-icon">ğŸ™ï¸</span><span class="pc-label"></span><span
        class="pc-value elec-color">12 kWh/100</span></div>
    <div class="preset-card" id="pc-kwh-extra"> <span class="pc-icon">ğŸ›£ï¸</span><span class="pc-label"></span><span
        class="pc-value elec-color">16 kWh/100</span></div>
    <div class="preset-card" id="pc-kwh-auto"> <span class="pc-icon">ğŸ›¤ï¸</span><span class="pc-label"></span><span
        class="pc-value elec-color">20 kWh/100</span></div>
  </div>

  <div class="app">
    <div class="panel">

      <!-- 1. TESTO GUIDA -->
      <div class="guide-box" id="guide-box">
        <p id="guide-text"></p>
      </div>

      <!-- 2. KM ANNUI + PREZZI REALI -->
      <div>
        <div class="section-label" id="sec-usage"></div>
        <div class="slider-group">

          <div class="slider-item">
            <div class="slider-header">
              <span class="slider-name neutral-color" id="sl-label-kmanno"></span>
              <div class="slider-value-wrap">
                <span class="slider-value" id="kmanno-display">â€”</span>
                <button class="edit-btn" onclick="openModal('kmanno')">âœ</button>
              </div>
            </div>
            <input type="range" class="neutral" id="sl-kmanno" min="5000" max="50000" step="1000" value="15000">
          </div>

          <div class="slider-item">
            <div class="slider-header">
              <span class="slider-name save-color" id="sl-label-realfuel"></span>
              <div class="slider-value-wrap">
                <span class="slider-value" id="real-fuel-display">â€”</span>
                <button class="edit-btn" onclick="openModal('realfuel')">âœ</button>
              </div>
            </div>
            <input type="range" class="save" id="sl-realfuel" min="0.50" max="3.50" step="0.01" value="1.65">
          </div>

          <div class="slider-item">
            <div class="slider-header">
              <span class="slider-name save-color" id="sl-label-realelec"></span>
              <div class="slider-value-wrap">
                <span class="slider-value" id="real-elec-display">â€”</span>
                <button class="edit-btn" onclick="openModal('realelec')">âœ</button>
              </div>
            </div>
            <input type="range" class="save" id="sl-realelec" min="0.05" max="0.80" step="0.01" value="0.30">
          </div>

        </div>
      </div>

      <hr class="section-divider">

      <!-- 3. CONSUMI -->
      <div>
        <div class="section-label" id="sec-consumption"></div>
        <div class="slider-group">

          <div class="slider-item">
            <div class="slider-header">
              <span class="slider-name fuel-color">
                <span id="sl-label-fuel"></span>
                <div class="preset-wrapper">
                  <button class="preset-btn" onclick="togglePopup('popup-kml',this)">â–¾ preset</button>
                </div>
              </span>
              <div class="slider-value-wrap">
                <span class="slider-value" id="kml-display">â€”</span>
                <button class="edit-btn" onclick="openModal('kml')">âœ</button>
              </div>
            </div>
            <input type="range" class="fuel" id="sl-kml" min="4" max="30" step="0.5" value="17">
          </div>

          <div class="slider-item">
            <div class="slider-header">
              <span class="slider-name elec-color">
                <span id="sl-label-elec"></span>
                <div class="preset-wrapper">
                  <button class="preset-btn" onclick="togglePopup('popup-kwh',this)">â–¾ preset</button>
                </div>
              </span>
              <div class="slider-value-wrap">
                <span class="slider-value" id="kwh-display">â€”</span>
                <button class="edit-btn" onclick="openModal('kwh')">âœ</button>
              </div>
            </div>
            <input type="range" class="elec" id="sl-kwh" min="8" max="35" step="0.5" value="16">
          </div>

        </div>
      </div>

      <hr class="section-divider">

      <!-- 4. PREZZI BREAKEVEN -->
      <div id="section-breakeven-prices">
        <div class="section-label" id="sec-breakeven"></div>
        <div class="slider-group">

          <div class="slider-item" id="item-pfuel">
            <div class="slider-header">
              <span class="slider-name fuel-color" id="sl-label-pfuel"></span>
              <div class="slider-value-wrap">
                <span class="slider-value" id="price-fuel-display">â€”</span>
                <button class="edit-btn" id="edit-pfuel-btn" onclick="openModal('pfuel')">âœ</button>
              </div>
            </div>
            <input type="range" class="fuel" id="sl-pfuel" min="0.50" max="3.50" step="0.01" value="1.65">
          </div>

          <div class="slider-item" id="item-pelec">
            <div class="slider-header">
              <span class="slider-name elec-color" id="sl-label-pelec"></span>
              <div class="slider-value-wrap">
                <span class="slider-value" id="price-elec-display">â€”</span>
                <button class="edit-btn" id="edit-pelec-btn" onclick="openModal('pelec')">âœ</button>
              </div>
            </div>
            <input type="range" class="elec" id="sl-pelec" min="0.05" max="0.80" step="0.01" value="0.30">
          </div>

        </div>
      </div>

      <!-- 5. BOX RISULTATO -->
      <div class="result-box breakeven" id="result-box">
        <div class="rb-label green" id="rb-sv-label"></div>
        <div class="rb-main" id="rb-sv-value">â€”</div>
        <div class="rb-note" id="rb-sv-note">â€”</div>
        <hr class="rb-divider" id="rb-divider">
        <div class="rb-label green" id="rb-be-label"></div>
        <div class="rb-main green" id="rb-be-value">â€”</div>
        <div class="rb-note" id="rb-be-note">â€”</div>
      </div>

      <!-- 6. MODALITÃ€ -->
      <hr class="section-divider">
      <div>
        <div class="section-label" id="sec-mode"></div>
        <div class="mode-group">
          <button class="mode-btn" id="mode-free" onclick="setMode('free')">
            <span class="dot"></span><span id="mode-free-label"></span><span class="mode-icon">â†”</span>
          </button>
          <button class="mode-btn" id="mode-elec" onclick="setMode('elec')">
            <span class="dot"></span><span id="mode-elec-label"></span><span class="mode-icon">âŸ³</span>
          </button>
          <button class="mode-btn" id="mode-fuel" onclick="setMode('fuel')">
            <span class="dot"></span><span id="mode-fuel-label"></span><span class="mode-icon">âŸ³</span>
          </button>
        </div>
      </div>

    </div>

    <!-- CHART -->
    <div class="chart-panel">
      <div>
        <div class="chart-title" id="chart-title"></div>
        <div class="chart-subtitle" id="chart-subtitle">â€”</div>
      </div>
      <div class="chart-container" id="chart-container">
        <canvas id="myChart"></canvas>
      </div>
      <div class="chart-placeholder" id="chart-placeholder" style="display:none;">
        <p id="chart-placeholder-text"></p>
      </div>
    </div>
  </div>

  <!-- i18n deve stare prima di nav.js e del resto -->
  <script src="i18n.js"></script>
  <script src="nav.js"></script>
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Applica testi i18n statici
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.title = t.pageTitle;
    document.getElementById('sec-usage').textContent = t.secUsage;
    document.getElementById('sec-consumption').textContent = t.secConsumption;
    document.getElementById('sec-breakeven').textContent = t.secBreakeven;
    document.getElementById('sec-mode').textContent = t.secMode;
    document.getElementById('sl-label-kmanno').textContent = t.slKmAnno;
    document.getElementById('sl-label-realfuel').textContent = t.slRealFuel;
    document.getElementById('sl-label-realelec').textContent = t.slRealElec;
    document.getElementById('sl-label-fuel').textContent = t.slFuel;
    document.getElementById('sl-label-elec').textContent = t.slElec;
    document.getElementById('sl-label-pfuel').textContent = t.slPFuel;
    document.getElementById('sl-label-pelec').textContent = t.slPElec;
    document.getElementById('rb-sv-label').textContent = t.rbSvLabel;
    document.getElementById('rb-be-label').textContent = t.rbBeLabel;
    document.getElementById('mode-free-label').textContent = t.modeFree;
    document.getElementById('mode-elec-label').textContent = t.modeElec;
    document.getElementById('mode-fuel-label').textContent = t.modeFuel;
    document.getElementById('chart-title').textContent = t.chartTitle;
    document.getElementById('chart-placeholder-text').textContent = t.chartPlaceholder;
    document.getElementById('btn-ok').textContent = t.btnOk;
    document.getElementById('btn-cancel').textContent = t.btnCancel;

    // preset labels
    document.querySelector('#pc-kml-city  .pc-label').textContent = t.presetKmlCity;
    document.querySelector('#pc-kml-mid   .pc-label').textContent = t.presetKmlMid;
    document.querySelector('#pc-kml-sport .pc-label').textContent = t.presetKmlSport;
    document.querySelector('#pc-kwh-city  .pc-label').textContent = t.presetKwhCity;
    document.querySelector('#pc-kwh-extra .pc-label').textContent = t.presetKwhExtra;
    document.querySelector('#pc-kwh-auto  .pc-label').textContent = t.presetKwhAuto;

    // preset onclick (collegato ora che t Ã¨ disponibile)
    document.getElementById('pc-kml-city').onclick = () => applyPreset('kml', 21);
    document.getElementById('pc-kml-mid').onclick = () => applyPreset('kml', 17);
    document.getElementById('pc-kml-sport').onclick = () => applyPreset('kml', 12);
    document.getElementById('pc-kwh-city').onclick = () => applyPreset('kwh', 12);
    document.getElementById('pc-kwh-extra').onclick = () => applyPreset('kwh', 16);
    document.getElementById('pc-kwh-auto').onclick = () => applyPreset('kwh', 20);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Intl formatting
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const fmtP3 = new Intl.NumberFormat(navigator.language, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
    const fmtP1 = new Intl.NumberFormat(navigator.language, { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    const fmtInt = new Intl.NumberFormat(navigator.language, { maximumFractionDigits: 0 });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // State + localStorage
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const STORAGE_KEY = 'volttool_v4';
    const defaults = { kml: 17, kwh100: 16, pFuel: 1.65, pElec: 0.30, realFuel: 1.65, realElec: 0.30, kmAnno: 15000, mode: 'free' };
    function loadState() { try { const r = localStorage.getItem(STORAGE_KEY); if (r) return { ...defaults, ...JSON.parse(r) }; } catch (e) { } return { ...defaults }; }
    function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { } }

    const state = loadState();
    let mode = state.mode;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DOM refs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const slKml = document.getElementById('sl-kml');
    const slKwh = document.getElementById('sl-kwh');
    const slPFuel = document.getElementById('sl-pfuel');
    const slPElec = document.getElementById('sl-pelec');
    const slKmAnno = document.getElementById('sl-kmanno');
    const slRealFuel = document.getElementById('sl-realfuel');
    const slRealElec = document.getElementById('sl-realelec');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Chart
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const CHART_STEPS = 120;
    const RANGE_DEFAULTS = { elec: { xMin: 0.05, xMax: 0.80 }, fuel: { xMin: 0.50, xMax: 3.50 } };
    let chartRange = { xMin: null, xMax: null, axis: null };

    function getStableRange(breakEven, axis) {
      if (chartRange.axis !== axis || chartRange.xMin === null) chartRange = { ...RANGE_DEFAULTS[axis], axis };
      const span = chartRange.xMax - chartRange.xMin;
      if (breakEven < chartRange.xMin + span * 0.15) chartRange.xMin = Math.max(0.001, breakEven - span * 0.4);
      if (breakEven > chartRange.xMax - span * 0.15) chartRange.xMax = breakEven + span * 0.4;
      return { xMin: chartRange.xMin, xMax: chartRange.xMax, step: (chartRange.xMax - chartRange.xMin) / CHART_STEPS };
    }
    function resetChartRange() { chartRange = { xMin: null, xMax: null, axis: null }; }

    const chart = new Chart(document.getElementById('myChart').getContext('2d'), {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 150 },
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { labels: { color: '#9aa0b0', font: { family: 'DM Mono', size: 11 }, boxWidth: 12 } },
          tooltip: {
            backgroundColor: '#1e2127', borderColor: '#2a2d35', borderWidth: 1,
            titleColor: '#e8eaf0', bodyColor: '#9aa0b0',
            titleFont: { family: 'DM Mono', size: 11 }, bodyFont: { family: 'DM Mono', size: 11 },
            callbacks: { label: c => c.parsed.y != null ? ` ${c.dataset.label}: ${fmtP3.format(c.parsed.y)} â‚¬/km` : '' }
          }
        },
        scales: {
          x: { ticks: { color: '#6b7080', font: { family: 'DM Mono', size: 10 }, maxTicksLimit: 10 }, grid: { color: '#1e2127' }, title: { display: true, color: '#6b7080', font: { family: 'DM Mono', size: 11 } } },
          y: { ticks: { color: '#6b7080', font: { family: 'DM Mono', size: 10 }, callback: v => fmtP3.format(v) + ' â‚¬' }, grid: { color: '#2a2d35' }, title: { display: true, text: t.axisEuroKmY, color: '#6b7080', font: { family: 'DM Mono', size: 11 } } }
        }
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Mode
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setMode(m) {
      mode = m; state.mode = m;
      document.getElementById('mode-free').className = 'mode-btn' + (mode === 'free' ? ' active-free' : '');
      document.getElementById('mode-elec').className = 'mode-btn' + (mode === 'elec' ? ' active-elec' : '');
      document.getElementById('mode-fuel').className = 'mode-btn' + (mode === 'fuel' ? ' active-fuel' : '');

      const guideBox = document.getElementById('guide-box');
      const guideText = document.getElementById('guide-text');
      if (mode === 'free') { guideBox.className = 'guide-box free-accent'; guideText.innerHTML = t.guideFree; }
      if (mode === 'elec') { guideBox.className = 'guide-box'; guideText.innerHTML = t.guideElec; }
      if (mode === 'fuel') { guideBox.className = 'guide-box elec-accent'; guideText.innerHTML = t.guideFuel; }

      document.getElementById('section-breakeven-prices').style.display = mode === 'free' ? 'none' : '';
      document.getElementById('item-pfuel').style.display = mode === 'fuel' ? 'none' : '';
      document.getElementById('item-pelec').style.display = mode === 'elec' ? 'none' : '';
      document.getElementById('chart-container').style.display = mode === 'free' ? 'none' : '';
      document.getElementById('chart-placeholder').style.display = mode === 'free' ? 'flex' : 'none';

      const rb = document.getElementById('result-box');
      rb.className = 'result-box ' + (mode === 'free' ? 'free-mode' : 'breakeven');
      const beVisible = mode !== 'free';
      document.getElementById('rb-divider').style.display = beVisible ? '' : 'none';
      document.getElementById('rb-be-label').style.display = beVisible ? '' : 'none';
      document.getElementById('rb-be-value').style.display = beVisible ? '' : 'none';
      document.getElementById('rb-be-note').style.display = beVisible ? '' : 'none';

      const svLabel = document.getElementById('rb-sv-label');
      svLabel.textContent = mode === 'free' ? t.svLabelFree : t.svLabelBreakeven;
      svLabel.className = 'rb-label ' + (mode === 'free' ? 'purple' : 'green');

      resetChartRange();
      updateUI();
      saveState();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Slider fill
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateTrack(el) {
      const item = el.closest('.slider-item');
      if (item && item.style.display === 'none') return;
      const pct = (parseFloat(el.value) - parseFloat(el.min)) / (parseFloat(el.max) - parseFloat(el.min)) * 100;
      el.style.setProperty('--pct', pct + '%');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // updateUI
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateUI() {
      state.kml = parseFloat(slKml.value);
      state.kwh100 = parseFloat(slKwh.value);
      state.kmAnno = parseFloat(slKmAnno.value);
      state.realFuel = parseFloat(slRealFuel.value);
      state.realElec = parseFloat(slRealElec.value);

      if (mode === 'elec') {
        state.pFuel = parseFloat(slPFuel.value);
        state.pElec = state.pFuel / (state.kml * (state.kwh100 / 100));
      } else if (mode === 'fuel') {
        state.pElec = parseFloat(slPElec.value);
        state.pFuel = (state.kwh100 / 100) * state.pElec * state.kml;
      }

      [slKml, slKwh, slPFuel, slPElec, slKmAnno, slRealFuel, slRealElec].forEach(updateTrack);

      document.getElementById('kml-display').textContent =
        `${fmtP1.format(state.kml)} ${t.unitKml} | ${fmtP1.format(100 / state.kml)} ${t.unitL100}`;
      document.getElementById('kwh-display').textContent =
        `${fmtP1.format(state.kwh100)} ${t.unitKwhKm} | ${fmtP1.format(100 / state.kwh100)} ${t.unitKmKwh}`;
      document.getElementById('real-fuel-display').textContent = fmtP3.format(state.realFuel) + ' â‚¬';
      document.getElementById('real-elec-display').textContent = fmtP3.format(state.realElec) + ' â‚¬';
      document.getElementById('kmanno-display').textContent = fmtInt.format(state.kmAnno) + ' km';

      if (mode !== 'free') {
        const fuelDisp = document.getElementById('price-fuel-display');
        const elecDisp = document.getElementById('price-elec-display');
        fuelDisp.textContent = fmtP3.format(state.pFuel) + ' â‚¬';
        elecDisp.textContent = fmtP3.format(state.pElec) + ' â‚¬';
        fuelDisp.className = 'slider-value' + (mode === 'fuel' ? ' computed' : '');
        elecDisp.className = 'slider-value' + (mode === 'elec' ? ' computed' : '');
      }

      const cpkmRealFuel = (1 / state.kml) * state.realFuel;
      const cpkmRealElec = (state.kwh100 / 100) * state.realElec;
      const diffPerKm = cpkmRealFuel - cpkmRealElec;
      const risparmio = diffPerKm * state.kmAnno;
      const absRisp = Math.abs(risparmio);
      const svEl = document.getElementById('rb-sv-value');
      const kmF = fmtInt.format(state.kmAnno);
      const cfF = fmtP3.format(cpkmRealFuel);
      const ceF = fmtP3.format(cpkmRealElec);
      const diffF = fmtP3.format(Math.abs(diffPerKm));
      const rispF = fmtInt.format(Math.round(absRisp));

      if (Math.abs(risparmio) < 0.50) {
        svEl.textContent = t.svZero;
        svEl.className = 'rb-main zero';
        document.getElementById('rb-sv-note').textContent = t.svNoteZero;
      } else if (diffPerKm > 0) {
        svEl.textContent = t.svElecWins(rispF);
        svEl.className = 'rb-main elec-save';
        document.getElementById('rb-sv-note').textContent = t.svNoteElec(kmF, cfF, ceF, diffF);
      } else {
        svEl.textContent = t.svFuelWins(rispF);
        svEl.className = 'rb-main fuel-save';
        document.getElementById('rb-sv-note').textContent = t.svNoteFuel(kmF, cfF, ceF, diffF);
      }

      if (mode !== 'free') {
        const cpkm = (1 / state.kml) * state.pFuel;
        const pFF = fmtP3.format(state.pFuel);
        const pEF = fmtP3.format(state.pElec);
        const cpkmF = fmtP3.format(cpkm);
        if (mode === 'elec') {
          document.getElementById('rb-be-value').textContent = t.beValueElec(pEF);
          document.getElementById('rb-be-note').textContent = t.beNoteElec(pFF, pEF, cpkmF);
        } else {
          document.getElementById('rb-be-value').textContent = t.beValueFuel(pFF);
          document.getElementById('rb-be-note').textContent = t.beNoteFuel(pEF, pFF, cpkmF);
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // updateChart
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateChart() {
      if (mode === 'free') return;
      const labels = [], fuelLine = [], elecLine = [];
      let breakEven, axis;

      if (mode === 'elec') {
        axis = 'elec'; breakEven = state.pElec;
        chart.options.scales.x.title.text = t.axisEuroKwh;
        document.getElementById('chart-subtitle').textContent = t.chartSubElec(fmtP3.format(state.pFuel));
        const { xMin, xMax, step } = getStableRange(breakEven, axis);
        for (let p = xMin; p <= xMax + step * 0.01; p += step) {
          labels.push(fmtP3.format(p));
          fuelLine.push((1 / state.kml) * state.pFuel);
          elecLine.push((state.kwh100 / 100) * p);
        }
      } else {
        axis = 'fuel'; breakEven = state.pFuel;
        chart.options.scales.x.title.text = t.axisEuroL;
        document.getElementById('chart-subtitle').textContent = t.chartSubFuel(fmtP3.format(state.pElec));
        const { xMin, xMax, step } = getStableRange(breakEven, axis);
        for (let p = xMin; p <= xMax + step * 0.01; p += step) {
          labels.push(fmtP3.format(p));
          fuelLine.push((1 / state.kml) * p);
          elecLine.push((state.kwh100 / 100) * state.pElec);
        }
      }

      const step = (chartRange.xMax - chartRange.xMin) / CHART_STEPS;
      const ci = Math.max(0, Math.min(labels.length - 1, Math.round((breakEven - chartRange.xMin) / step)));

      chart.data.labels = labels;
      chart.data.datasets = [
        {
          label: t.dsLabelFuel, data: fuelLine, borderColor: '#f5a623', backgroundColor: 'rgba(245,166,35,.06)', borderWidth: 2,
          pointRadius: fuelLine.map((_, i) => i === ci ? 7 : 0), pointBackgroundColor: '#f5a623', pointBorderColor: '#0e0f11', pointBorderWidth: 2, tension: 0, fill: false
        },
        {
          label: t.dsLabelElec, data: elecLine, borderColor: '#4fc3f7', backgroundColor: 'rgba(79,195,247,.06)', borderWidth: 2,
          pointRadius: elecLine.map((_, i) => i === ci ? 7 : 0), pointBackgroundColor: '#4fc3f7', pointBorderColor: '#0e0f11', pointBorderWidth: 2, tension: 0, fill: false
        },
        {
          label: t.dsLabelParity, data: fuelLine.map((v, i) => i === ci ? v : null),
          borderColor: 'transparent', backgroundColor: 'transparent',
          pointRadius: fuelLine.map((_, i) => i === ci ? 12 : 0), pointStyle: 'star', pointBorderWidth: 0, pointBackgroundColor: '#a8e6a3',
          fill: false, spanGaps: false
        }
      ];
      chart.update();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Preset popup
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let activePopup = null;
    function togglePopup(popupId, btn) {
      const popup = document.getElementById(popupId);
      if (activePopup && activePopup !== popup) activePopup.classList.remove('open');
      if (popup.classList.contains('open')) { popup.classList.remove('open'); activePopup = null; return; }
      const rect = btn.getBoundingClientRect();
      popup.style.top = (rect.bottom + 6) + 'px';
      popup.style.left = rect.left + 'px';
      popup.classList.add('open');
      activePopup = popup;
    }
    function applyPreset(field, value) {
      if (field === 'kml') { state.kml = value; slKml.value = Math.max(4, Math.min(30, value)); }
      if (field === 'kwh') { state.kwh100 = value; slKwh.value = Math.max(8, Math.min(35, value)); }
      if (activePopup) { activePopup.classList.remove('open'); activePopup = null; }
      resetChartRange();
      updateUI(); updateChart(); saveState();
    }
    document.addEventListener('click', e => {
      if (activePopup && !activePopup.contains(e.target) && !e.target.classList.contains('preset-btn')) {
        activePopup.classList.remove('open'); activePopup = null;
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Modal
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let modalTarget = null;
    const modalCfg = {
      kml: { title: () => t.modalTitleKml, desc: () => t.modalDescKml, min: 1, max: 200, step: 0.1, stateKey: 'kml', slid: () => slKml, slidMin: 4, slidMax: 30 },
      kwh: { title: () => t.modalTitleKwh, desc: () => t.modalDescKwh, min: 1, max: 200, step: 0.1, stateKey: 'kwh100', slid: () => slKwh, slidMin: 8, slidMax: 35 },
      pfuel: { title: () => t.modalTitlePfuel, desc: () => t.modalDescPfuel, min: 0.001, max: 50, step: 0.001, stateKey: 'pFuel', slid: () => slPFuel, slidMin: 0.5, slidMax: 3.5 },
      pelec: { title: () => t.modalTitlePelec, desc: () => t.modalDescPelec, min: 0.001, max: 50, step: 0.001, stateKey: 'pElec', slid: () => slPElec, slidMin: 0.05, slidMax: 0.8 },
      kmanno: { title: () => t.modalTitleKmanno, desc: () => t.modalDescKmanno, min: 1000, max: 500000, step: 1000, stateKey: 'kmAnno', slid: () => slKmAnno, slidMin: 5000, slidMax: 50000 },
      realfuel: { title: () => t.modalTitleRFuel, desc: () => t.modalDescRFuel, min: 0.001, max: 50, step: 0.001, stateKey: 'realFuel', slid: () => slRealFuel, slidMin: 0.5, slidMax: 3.5 },
      realelec: { title: () => t.modalTitleRElec, desc: () => t.modalDescRElec, min: 0.001, max: 50, step: 0.001, stateKey: 'realElec', slid: () => slRealElec, slidMin: 0.05, slidMax: 0.8 },
    };
    function openModal(target) {
      modalTarget = target;
      const cfg = modalCfg[target];
      document.getElementById('modal-title').textContent = cfg.title();
      document.getElementById('modal-desc').textContent = cfg.desc();
      const inp = document.getElementById('modal-input');
      inp.min = cfg.min; inp.max = cfg.max; inp.step = cfg.step; inp.value = state[cfg.stateKey];
      document.getElementById('modal-overlay').classList.add('open');
      setTimeout(() => { inp.focus(); inp.select(); }, 60);
    }
    function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); modalTarget = null; }
    function confirmModal() {
      if (!modalTarget) return;
      const cfg = modalCfg[modalTarget];
      let val = parseFloat(document.getElementById('modal-input').value);
      if (isNaN(val)) { closeModal(); return; }
      val = Math.max(cfg.min, val);
      state[cfg.stateKey] = val;
      cfg.slid().value = Math.max(cfg.slidMin, Math.min(cfg.slidMax, val));
      if (modalTarget === 'kml' || modalTarget === 'kwh') resetChartRange();
      closeModal(); updateUI(); updateChart(); saveState();
    }
    document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    document.getElementById('modal-input').addEventListener('keydown', e => { if (e.key === 'Enter') confirmModal(); });
    document.getElementById('btn-ok').addEventListener('click', confirmModal);
    document.getElementById('btn-cancel').addEventListener('click', closeModal);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Event listeners + Init
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    [slKml, slKwh, slPFuel, slPElec, slKmAnno, slRealFuel, slRealElec].forEach(sl => {
      sl.addEventListener('input', updateUI);
      sl.addEventListener('change', () => { updateChart(); saveState(); });
    });
    [slKml, slKwh].forEach(sl => sl.addEventListener('change', resetChartRange));

    slKml.value = Math.max(4, Math.min(30, state.kml));
    slKwh.value = Math.max(8, Math.min(35, state.kwh100));
    slPFuel.value = Math.max(0.5, Math.min(3.5, state.pFuel));
    slPElec.value = Math.max(0.05, Math.min(0.8, state.pElec));
    slKmAnno.value = Math.max(5000, Math.min(50000, state.kmAnno));
    slRealFuel.value = Math.max(0.5, Math.min(3.5, state.realFuel));
    slRealElec.value = Math.max(0.05, Math.min(0.8, state.realElec));

    setMode(mode);
  </script>
</body>

</html>